name: Prepare and sync with public repo

on:
  workflow_dispatch:

env:
  SSH_AUTH_SOCK: /tmp/ssh_agent.sock
  SPM_DEPENDENCIES_CACHE_PATH: ./vendor/ios_dependencies

jobs:
  prepare-and-sync:
    runs-on: macos-15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Authorize SSH session
        env:
          SSH_KEY: ${{ secrets.IOS_DEPENDENCIES_READ_ONLY_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com > ~/.ssh/known_hosts
          echo "${SSH_KEY}" > ~/.ssh/ios_dependencies_ssh_key
          chmod 600 ~/.ssh/ios_dependencies_ssh_key
          ssh-agent -a "${SSH_AUTH_SOCK}" > /dev/null || true
          ssh-add ~/.ssh/ios_dependencies_ssh_key

      # When using Github runner images, the preferred way of setting the Ruby version is to use this official action instead of using rvm/rbenv
      - name: Install Ruby
        uses: ruby/setup-ruby@a2bbe5b1b236842c1cb7dd11e8e3b51e0a616acc  # v1.202.0

      # Skipping Ruby installation since it has been already installed by an action above
      - name: Install required dependencies
        run: ./bootstrap.sh --skip-ruby

      - name: Fetch and cache SPM dependencies
        run: |
          bundle exec fastlane cache_spm_dependencies cache_path:${SPM_DEPENDENCIES_CACHE_PATH}

      - name: Remove unused files
        run: |
          du -d 0 -h ${SPM_DEPENDENCIES_CACHE_PATH}
          rm -rf .jira
          rm -rf .github/workflows
          rm -rf .gitmodules
          rm -rf fastlane

      - name: Sync changes
        if: false # TODO: Test only
        run: |
          git remote add "public-repo" "git@github.com:tangem-developments/tangem-sdk-ios-test-sync-repo.git" # TODO: Test only
