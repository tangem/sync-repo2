name: Alpha - Build and Deploy 

on:
  workflow_dispatch:
  
env:
  app_path: "fastlane/builds/app.ipa"
  artifact_name: Tangem App
  slack_channel: "#deployments-ios"
  
jobs:
 start_notification:
   name: Notification
   runs-on: self-hosted
   steps:
   - name: Prepare statuses
     id: statuses
     run: |
       echo "status=\"ðŸ•‘ *Buildingâ€¦*\"" >> $GITHUB_OUTPUT
       echo "color=\"#000000\"" >> $GITHUB_OUTPUT
   - id: slack
     uses: slackapi/slack-github-action@v1.23.0
     with:
      channel-id: ${{ env.slack_channel }}
      payload: |
        {
            "text": "{TEXT}",
            "blocks": [
                {
                    "type": "header",
                    "text": {
                        "type": "plain_text",
                        "text": "Alpha version â†’ Google Disribution",
                        "emoji": true
                    }
                },
                {
                    "type": "context",
                    "elements": [
                        {
                            "type": "mrkdwn",
                            "text": "${{ steps.statuses.status }}"
                        }
                    ]
                },
                {
                    "type": "section",
                    "fields": [
                        {
                            "type": "mrkdwn",
                            "text": "*Version:*\n{VERSION}"
                        },
                        {
                            "type": "mrkdwn",
                            "text": "*Build number:*\n{BUILD}"
                        }
                    ]
                },
                {
                    "type": "section",
                    "fields": [
                        {
                            "type": "mrkdwn",
                            "text": "*Branch:*\n${{ github.ref_name }}"
                        },
                        {
                            "type": "mrkdwn",
                            "text": "*Started by:*\n${{ github.actor }}"
                        }
                    ]
                },
                {
                    "type": "section",
                    "text": {
                        "type": "mrkdwn",
                        "text": "*Changelog:*\n{CHANGELOG}"
                    }
                },
                {
                    "type": "section",
                    "text": {
                        "type": "mrkdwn",
                        "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View this action on GitHub>"
                    }
                }
            ]
        }
   env:
    SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN}}
    
 build:
   name: Build
   needs: start_notification
   runs-on: self-hosted
   steps:
   - name: Clean
     run: rm -rf *
     
   - name: Checkout
     uses: actions/checkout@v3
     with:
       submodules: true
       token: ${{ secrets.GH_MOBILE_PAT }}
       
   - name: Bundle install
     run: bundle install --jobs 4 --retry 3
     
   - name: Jira Login
     uses: atlassian/gajira-login@master
     env:
       JIRA_BASE_URL: ${{ secrets.JIRA_URL }}
       JIRA_USER_EMAIL: ${{ secrets.JIRA_USER }}
       JIRA_API_TOKEN: ${{ secrets.JIRA_TOKEN }}
        
   - name: Get Jira Issue Number from Branch Name
     id: issue_number
     uses: tangem/jira-action@master
     with:
       action: getBranchSummary
       branch-name: ${{ github.ref_name }}
   
   - name: Build
     run: bundle exec fastlane alpha build:"${{ github.run_number }}" version:"${{ steps.issue_number.outputs.key }}"
     
   - name: Upload binary artifact
     uses: actions/upload-artifact@v3
     with:
       name: ${{ env.artifact_name }}
       path: ${{ env.app_path }}
       if-no-files-found: error
     
 deploy:
   name: Deploy
   environment: Alpha
   needs: build
   runs-on: self-hosted
   steps:
   
#    TODO:REMOVE
   - name: Jira Login
     uses: atlassian/gajira-login@master
     env:
       JIRA_BASE_URL: ${{ secrets.JIRA_URL }}
       JIRA_USER_EMAIL: ${{ secrets.JIRA_USER }}
       JIRA_API_TOKEN: ${{ secrets.JIRA_TOKEN }}
        
   - name: Get Jira Issue Number from Branch Name
     id: issue_number
     uses: tangem/jira-action@master
     with:
       action: getBranchSummary
       branch-name: ${{ github.ref_name }}
   
   - name: Download the artifact
     uses: actions/download-artifact@v3
     with:
       name: ${{ env.artifact_name }}
       path: artifacts/
       
   - name: Deploy to Firebase
     run: bundle exec fastlane deploy_to_firebase app_id:"${{ secrets.FIREBASE_IOS_ALPHA_ID }}" path:"artifacts/app.ipa" firebase_token:"${{ secrets.FIREBASE_CLI_TOKEN }}" changelog:"${{ steps.issue_number.outputs.summary }}"
