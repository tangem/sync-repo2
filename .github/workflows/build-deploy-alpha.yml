name: Alpha - Build and Deploy 

on:
  workflow_dispatch:
  
env:
  app_path: "fastlane/builds/app.ipa"
  artifact_name: Tangem App
  slack_channel: "#deployments-ios"
  
jobs:
 build:
   name: Build
   runs-on: self-hosted
   steps:
   - name: Checkout
     uses: actions/checkout@v3
     with:
       submodules: true
       token: ${{ secrets.GH_MOBILE_PAT }}
       
   - name: Bundle install
     run: bundle install --jobs 4 --retry 3
     
   - name: Jira Login
     uses: atlassian/gajira-login@master
     env:
       JIRA_BASE_URL: ${{ secrets.JIRA_URL }}
       JIRA_USER_EMAIL: ${{ secrets.JIRA_USER }}
       JIRA_API_TOKEN: ${{ secrets.JIRA_TOKEN }}
        
   - name: Get Jira Issue Number from Branch Name
     id: issue_number
     uses: tangem/jira-action@master
     with:
       action: getBranchSummary
       branch-name: ${{ github.ref_name }}
   
   - name: Build
     run: bundle exec fastlane alpha build:${{ github.run_number }} version:${{ steps.issue_number.outputs.key }}
     
   - name: Upload binary artifact
     uses: actions/upload-artifact@v3
     with:
       name: ${{ env.artifact_name }}
       path: ${{ env.app_path }}
       if-no-files-found: error
       
   - name: Clean up
     run: rm -rf ${{ env.app_path }}
     
 deploy:
   name: Deploy
   needs: build
   runs-on: self-hosted
   steps:
   
#    TODO:REMOVE
   - name: Jira Login
     uses: atlassian/gajira-login@master
     env:
       JIRA_BASE_URL: ${{ secrets.JIRA_URL }}
       JIRA_USER_EMAIL: ${{ secrets.JIRA_USER }}
       JIRA_API_TOKEN: ${{ secrets.JIRA_TOKEN }}
        
   - name: Get Jira Issue Number from Branch Name
     id: issue_number
     uses: tangem/jira-action@master
     with:
       action: getBranchSummary
       branch-name: ${{ github.ref_name }}
   
   - name: Download the artifact
     uses: actions/download-artifact@v3
     with:
       name: ${{ env.artifact_name }}
       path: ${{ env.app_path }}
       
   - name: Deploy to Firebase
     run: |
       bundle exec fastlane deploy_to_firebase app_id:${{ secrets.FIREBASE_IOS_ALPHA_ID }} \ 
                                               path:${{ env.app_path }} \
                                               firebase_token:${{ secrets.FIREBASE_CLI_TOKEN }} \
                                               changelog:${{ steps.issue_number.outputs.summary }}
